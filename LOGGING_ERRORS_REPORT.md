# Отчет о найденных ошибках в системе логирования
**Дата создания:** 2025-10-29
**Анализатор:** AI Debug Assistant

## Резюме
Обнаружено 8 типов критических ошибок, влияющих на стабильность приложения. Основные проблемы связаны с асинхронностью, отсутствующими импортами и конфликтами базы данных.

## Детальный анализ ошибок

### 1. TypeError: object dict can't be used in 'await' expression
**Источники:** UserService, ScoreRepository, ModerationService
**Частота:** Высокая (более 30 вхождений в тестах)
**Причина:** Синхронные вызовы асинхронных методов репозитория
**Влияние:** Полное блокирование работы сервисов пользователей и модерации
**Приоритет исправления:** Критический

### 2. NameError: name 'time' is not defined
**Источники:** application.py dispatcher callback
**Частота:** Средняя (многократные вхождения)
**Причина:** Отсутствующий импорт time
**Влияние:** Сбой callback обработчиков меню
**Приоритет исправления:** Высокий

### 3. NameError: name 'InlineKeyboardButton' is not defined
**Источники:** application.py menu_donate callback
**Частота:** Средняя
**Причина:** Отсутствующий импорт из telegram
**Влияние:** Сбой меню донатов
**Приоритет исправления:** Высокий

### 4. NameError: name 'UserHandlers' is not defined
**Источники:** application.py _setup_unified_router
**Частота:** Средняя
**Причина:** Отсутствующий класс или импорт
**Влияние:** Сбой новой системы маршрутизации
**Приоритет исправления:** Высокий

### 5. AttributeError: 'Application' object has no attribute 'unified_router'
**Источники:** application.py _handle_command_fallback
**Частота:** Высокая (множественные команды)
**Причина:** unified_router не инициализирован
**Влияние:** Полное блокирование команд бота
**Приоритет исправления:** Критический

### 6. sqlite3.OperationalError: database is locked
**Источники:** database/repository.py, application startup
**Частота:** Высокая при параллельном запуске
**Причина:** Конкуренция за SQLite базу данных
**Влияние:** Невозможность запуска приложения
**Приоритет исправления:** Высокий

### 7. httpx.ConnectError: Connection attempts failed
**Источники:** Telegram API обработчик ошибок
**Частота:** Средняя (при сетевых проблемах)
**Причина:** Сетевые сбои или блокировка API
**Влияние:** Прерывание работы бота
**Приоритет исправления:** Средний

### 8. Conflict: terminated by other getUpdates request
**Источники:** Telegram Bot API
**Частота:** При множественных экземплярах
**Причина:** Запуск нескольких копий бота
**Влияние:** Прерывание работы существующего бота
**Приоритет исправления:** Высокий

## Матрица приоритетов исправления

| Ошибка | Приоритет | Сложность | Влияние на систему |
|--------|-----------|-----------|-------------------|
| TypeError асинхронности | Критический | Средняя | Полная блокировка сервисов |
| AttributeError unified_router | Критический | Высокая | Полная блокировка команд |
| NameError импорты | Высокий | Низкая | Частичные сбои функций |
| Database locked | Высокий | Средняя | Невозможность запуска |
| Multiple bot instances | Высокий | Средняя | Прерывание работы |
| Network errors | Средний | Средняя | Временные сбои |
| Telegram API conflicts | Средний | Низкая | Временные проблемы |

## План исправления

### Фаза 1: Критические исправления (1-2 дня)
1. Исправить все TypeError асинхронных вызовов
2. Инициализировать unified_router в Application
3. Добавить недостающие импорты (time, InlineKeyboardButton, UserHandlers)
4. Реализовать защиту от множественных экземпляров

### Фаза 2: Высокоприоритетные исправления (2-3 дня)
1. Решить проблему database locked (WAL mode, connection pooling)
2. Улучшить обработку сетевых ошибок с retry логикой
3. Синхронизировать CI с production базой данных

### Фаза 3: Оптимизация (1-2 дня)
1. Добавить проверки на None перед доступом к атрибутам
2. Улучшить логирование ошибок
3. Оптимизировать CI pipeline

## Метрики успеха
- Все интеграционные тесты проходят без ошибок
- Приложение запускается без database locked ошибок
- Нет конфликтов между экземплярами бота
- Улучшена стабильность работы при сетевых проблемах