"""
–°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.
–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
"""

from typing import Dict, Optional
from core.permissions import UserRole
from core.exceptions import ValidationError


class WelcomeService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
    - –ì–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π
    - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    - –í–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    """

    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π"""
        self.welcome_messages = self._initialize_welcome_messages()

    def _initialize_welcome_messages(self) -> Dict[str, str]:
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–æ–≤–∞—Ä—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π.
        –ù–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏–∑ welcome_messages_proposals.md
        """
        return {
            UserRole.USER.value: """üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –±–æ—Ç!

–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ:
‚Ä¢ üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–π —Ä–∞–Ω–≥: /rank
‚Ä¢ üèÜ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤: /leaderboard
‚Ä¢ üéØ –ò–≥—Ä–∞—Ç—å –≤ –∏–≥—Ä—ã: /play_game
‚Ä¢ üå¶Ô∏è –£–∑–Ω–∞—Ç—å –ø–æ–≥–æ–¥—É: /weather
‚Ä¢ üì∞ –ü—Ä–æ—á–∏—Ç–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏: /news
‚Ä¢ üí∏ –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç: /donate

–î–ª—è —Å–ø—Ä–∞–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help""",

            UserRole.MODERATOR.value: """üõ°Ô∏è –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –º–æ–¥–µ—Ä–∞—Ç–æ—Ä!

–í–∞—à–∏ –ø—Ä–∞–≤–∞:
‚Ä¢ ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: /warn
‚Ä¢ üîá –ó–∞–≥–ª—É—à–∫–∞: /mute /unmute
‚Ä¢ üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏

–í—Å–µ –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã —Ç–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã: /rank, /play_game, /weather –∏ –¥—Ä.""",

            UserRole.ADMIN.value: """üëë –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä!

–£ –≤–∞—Å –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –±–æ—Ç–æ–º:
‚Ä¢ üë• –ú–æ–¥–µ—Ä–∞—Ü–∏—è: /warn, /mute, /ban, /kick
‚Ä¢ üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: /admin_stats, /export_stats
‚Ä¢ üìù –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: /schedule_post, /list_posts
‚Ä¢ üõ†Ô∏è –°–∏—Å—Ç–µ–º–∞: /admin_errors, /report_error

–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã —Ç–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã.
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.""",

            UserRole.SUPER_ADMIN.value: """üîß –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!

–í–∞—à–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
‚Ä¢ ‚ö†Ô∏è –ú–æ–¥–µ—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: /warn /mute /ban
‚Ä¢ üìà –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: /admin_stats
‚Ä¢ üìÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º–∏: /schedule_post
‚Ä¢ üîç –†–∞–±–æ—Ç–∞ —Å –æ—à–∏–±–∫–∞–º–∏: /admin_errors
‚Ä¢ üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö: /export_stats

–û–±—ã—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: /rank /leaderboard /play_game –∏ –¥—Ä."""
        }

    def get_welcome_message(self, user_role: UserRole, user_name: Optional[str] = None) -> str:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ä–æ–ª–∏.

        Args:
            user_role: –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_name: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

        Raises:
            ValidationError: –ï—Å–ª–∏ —Ä–æ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
        """
        if not isinstance(user_role, UserRole):
            raise ValidationError(f"–ù–µ–≤–µ—Ä–Ω–∞—è —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_role}")

        # –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏
        base_message = self.welcome_messages.get(user_role.value)

        if not base_message:
            # Fallback –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            base_message = self.welcome_messages[UserRole.USER.value]

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ
        if user_name:
            # –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –Ω–∞—á–∞–ª–æ
            personal_greeting = f"üëã –ü—Ä–∏–≤–µ—Ç, {user_name}!\n\n"
            return personal_greeting + base_message
        else:
            # –ë–µ–∑—ã–º—è–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            return "üëã –ü—Ä–∏–≤–µ—Ç!\n\n" + base_message

    def get_available_commands_for_role(self, user_role: UserRole) -> Dict[str, list]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ä–æ–ª–∏.

        Args:
            user_role: –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        """
        if not isinstance(user_role, UserRole):
            raise ValidationError(f"–ù–µ–≤–µ—Ä–Ω–∞—è —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_role}")

        # –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        base_commands = {
            'user_commands': [
                '/start - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –Ω–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã',
                '/help - –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º',
                '/rank - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–∏—á–Ω–æ–≥–æ —Ä–∞–Ω–≥–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞',
                '/leaderboard - –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ –ø–æ –æ—á–∫–∞–º',
                '/info - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ',
                '/weather - –ü–æ–≥–æ–¥–∞',
                '/news - –ù–æ–≤–æ—Å—Ç–∏',
                '/translate - –ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞',
                '/donate - –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç'
            ],
            'games': [
                '/play_game - –í—ã–±–æ—Ä –∏–≥—Ä—ã',
                '/rock_paper_scissors - –ö–∞–º–µ–Ω—å-–Ω–æ–∂–Ω–∏—Ü—ã-–±—É–º–∞–≥–∞',
                '/tic_tac_toe - –ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏',
                '/quiz - –í–∏–∫—Ç–æ—Ä–∏–Ω–∞',
                '/battleship - –ú–æ—Ä—Å–∫–æ–π –±–æ–π',
                '/game_2048 - –ò–≥—Ä–∞ 2048',
                '/tetris - –¢–µ—Ç—Ä–∏—Å',
                '/snake - –ó–º–µ–π–∫–∞'
            ]
        }

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
        if user_role in [UserRole.MODERATOR, UserRole.ADMIN, UserRole.SUPER_ADMIN]:
            base_commands['moderation'] = [
                '/warn - –í—ã–¥–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ',
                '/mute - –ó–∞–≥–ª—É—à–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                '/unmute - –°–Ω—è—Ç—å –∑–∞–≥–ª—É—à–∫—É'
            ]

        if user_role in [UserRole.ADMIN, UserRole.SUPER_ADMIN]:
            base_commands['admin'] = [
                '/ban - –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                '/unban - –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                '/kick - –í—ã–≥–Ω–∞—Ç—å –∏–∑ —á–∞—Ç–∞',
                '/admin_stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–¥–º–∏–Ω–∞',
                '/schedule_post - –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é',
                '/list_posts - –°–ø–∏—Å–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤',
                '/delete_post - –£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç',
                '/publish_now - –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ',
                '/report_error - –°–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ',
                '/admin_errors - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∞–º–∏',
                '/export_stats - –≠–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏'
            ]

        if user_role == UserRole.SUPER_ADMIN:
            base_commands['super_admin'] = [
                '/admin_system - –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
                '/admin_logs - –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏',
                '/admin_restart - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º'
            ]

        return base_commands

    def validate_user_name(self, name: str) -> bool:
        """
        –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

        Args:
            name: –ò–º—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

        Returns:
            True –µ—Å–ª–∏ –∏–º—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ
        """
        if not name or not isinstance(name, str):
            return False

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É
        if len(name.strip()) < 1 or len(name) > 100:
            return False

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
        forbidden_chars = ['<', '>', '&', '\n', '\r']
        if any(char in name for char in forbidden_chars):
            return False

        return True