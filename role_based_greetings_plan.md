# üèó –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –ø–æ —Ä–æ–ª—è–º

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã) –≤ Telegram –±–æ—Ç–µ.

## üéØ –¶–µ–ª–∏

- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–æ–ª–µ–π
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –¥–ª—è –±—É–¥—É—â–∏—Ö —Ä–æ–ª–µ–π

## üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (Database Layer)
- **User –º–æ–¥–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `role` —Ç–∏–ø–∞ `str` —Å default `'user'`
- **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î**: ALTER TABLE users ADD COLUMN role TEXT DEFAULT 'user'
- **UserRepository**: –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–æ–ª—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 2. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (Services Layer)
- **RoleService**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - `assign_role(user_id: int, role: str) -> bool`
  - `get_user_role(user_id: int) -> str`
  - `validate_role(role: str) -> bool`
  - `is_admin(user_id: int) -> bool`
  - `is_moderator(user_id: int) -> bool`
- **UserService**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RoleService

### 3. –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–ª–æ–π (Handlers Layer)
- **messages.py**: –°–ª–æ–≤–∞—Ä—å `greetings_by_role` —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ –ø–æ —Ä–æ–ª—è–º
- **UserHandlers._handle_start**: –í—ã–±–æ—Ä –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–∏

### 4. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –î–æ–ø—É—Å—Ç–∏–º—ã–µ —Ä–æ–ª–∏: 'user', 'moderator', 'admin'
- Fallback –Ω–∞ 'user' –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–π –æ–±—ã—á–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

## üîÑ –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã

```mermaid
sequenceDiagram
    participant U as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant H as UserHandlers
    participant US as UserService
    participant RS as RoleService
    participant UR as UserRepository
    participant DB as Database

    U->>H: /start
    H->>US: get_or_create_user(user_id)
    US->>RS: get_user_role(user_id)
    RS->>UR: get_user_role(user_id)
    UR->>DB: SELECT role FROM users WHERE telegram_id = ?
    DB-->>UR: role
    UR-->>RS: role
    RS-->>US: role
    US-->>H: role
    H->>H: –í—ã–±–æ—Ä –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ role
    H->>U: –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```
telegram_bot/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ models.py              # + –ø–æ–ª–µ role –≤ User
‚îÇ   ‚îî‚îÄ‚îÄ repository.py          # + –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–æ–ª–µ–π
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ user_service.py        # –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ role_service.py        # –ù–û–í–´–ô
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îî‚îÄ‚îÄ user_handlers.py       # –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è _handle_start
‚îú‚îÄ‚îÄ messages.py                # + greetings_by_role
‚îî‚îÄ‚îÄ database_migration.sql     # –ù–û–í–´–ô: –º–∏–≥—Ä–∞—Ü–∏—è –ë–î
```

## üìã –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–ø–æ—à–∞–≥–æ–≤–æ)

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
1. ‚úÖ –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
2. üîÑ –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å User (–¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ role)
3. üîÑ –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
4. üîÑ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ —Ä–æ–ª—è–º –≤ messages.py

### –≠—Ç–∞–ø 2: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
5. üîÑ –°–æ–∑–¥–∞—Ç—å RoleService
6. üîÑ –û–±–Ω–æ–≤–∏—Ç—å UserService –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–æ–ª—è–º–∏
7. üîÑ –û–±–Ω–æ–≤–∏—Ç—å UserRepository

### –≠—Ç–∞–ø 3: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
8. üîÑ –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /start
9. üîÑ –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π
10. üîÑ –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ä–æ–ª–µ–π

### –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
11. üîÑ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ú–æ–¥–µ–ª—å User (database/models.py)
```python
@dataclass
class User:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    role: str = "user"  # –ù–û–í–û–ï –ü–û–õ–ï
```

### –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
```sql
ALTER TABLE users ADD COLUMN role TEXT DEFAULT 'user';
```

### –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ —Ä–æ–ª—è–º (messages.py)
```python
'greetings_by_role': {
    'user': '''–ü—Ä–∏–≤–µ—Ç, {name}! üëã
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç. –Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –∑–¥–µ—Å—å.
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.''',

    'moderator': '''–ü—Ä–∏–≤–µ—Ç, {name}! üëã
–ö–∞–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —á–∞—Ç–æ–º.
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –∫–æ–º–∞–Ω–¥ –º–æ–¥–µ—Ä–∞—Ü–∏–∏.''',

    'admin': '''–ü—Ä–∏–≤–µ—Ç, {name}! üëã
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –£ –≤–∞—Å –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –±–æ—Ç–æ–º.
–ù–∞—á–Ω–∏—Ç–µ —Å /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.'''
}
```

### RoleService (services/role_service.py)
```python
class RoleService:
    VALID_ROLES = {'user', 'moderator', 'admin'}

    def get_user_role(self, user_id: int) -> str:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –∏–∑ –ë–î

    def assign_role(self, user_id: int, role: str) -> bool:
        # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

    def validate_role(self, role: str) -> bool:
        return role in self.VALID_ROLES

    def is_admin(self, user_id: int) -> bool:
        return self.get_user_role(user_id) == 'admin'

    def is_moderator(self, user_id: int) -> bool:
        role = self.get_user_role(user_id)
        return role in {'moderator', 'admin'}
```

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

- ‚úÖ –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —Ä–æ–ª—å 'user' –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- ‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ø–æ–ª—É—á–∞—é—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- ‚úÖ –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–∞–≤–∞—Ö
- ‚úÖ Fallback —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å —Ä–æ–ª–∏

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞–Ω–∞:
1. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ —Ä–µ–∂–∏–º code –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
2. –ù–∞—á–∞—Ç—å —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ User
3. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö —Ä–æ–ª—è—Ö

---
*–°–æ–∑–¥–∞–Ω–æ: 27 –æ–∫—Ç—è–±—Ä—è 2025 –≥.*
*–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏*