# üìä –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç–∞ –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Prometheus, Sentry –∏ –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∞–ª–µ—Ä—Ç–æ–≤.

## üöÄ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (Structured Logging)
- **–§–æ—Ä–º–∞—Ç**: JSON –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
- **–£—Ä–æ–≤–Ω–∏**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **–†–æ—Ç–∞—Ü–∏—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –û—Ç–ø—Ä–∞–≤–∫–∞ ERROR –∏ –≤—ã—à–µ –≤ Sentry

### 2. –ú–µ—Ç—Ä–∏–∫–∏ (Prometheus)
- **–°–µ—Ä–≤–µ—Ä –º–µ—Ç—Ä–∏–∫**: HTTP endpoint –Ω–∞ –ø–æ—Ä—Ç—É 8000 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ)
- **–°–æ–±–∏—Ä–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏**:
  - `telegram_bot_errors_total` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø–æ —Ç–∏–ø–∞–º
  - `telegram_bot_command_duration_seconds` - –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
  - `telegram_bot_active_users` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - `telegram_bot_messages_total` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
  - `telegram_bot_api_response_time_seconds` - –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö API
  - `telegram_bot_status` - —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ (1=—Ä–∞–±–æ—Ç–∞–µ—Ç, 0=–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ (Sentry)
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞—Ö–≤–∞—Ç**: –í—Å–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- **Performance monitoring**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Ç–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### 4. –°–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç–æ–≤ (AlertManager)
- **–¢–∏–ø—ã –∞–ª–µ—Ä—Ç–æ–≤**:
  - –í—ã—Å–æ–∫–∞—è —á–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫ (>10 –≤ –º–∏–Ω—É—Ç—É)
  - –ü–∞–¥–µ–Ω–∏–µ –±–æ—Ç–∞
  - –í—ã—Å–æ–∫–æ–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ (>5 —Å–µ–∫—É–Ω–¥)
  - –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –ë–î
- **–ö–∞–Ω–∞–ª—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**:
  - Telegram (—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º)
  - Email
  - Webhook

## üõ† –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install prometheus_client sentry-sdk
```

### 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `config_local.py`:

```python
# –í–∫–ª—é—á–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
ENABLE_SENTRY = True
SENTRY_DSN = "https://your-dsn@sentry.io/project-id"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Prometheus
PROMETHEUS_PORT = 8000

# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
ENABLE_DEVELOPER_NOTIFICATIONS = True
DEVELOPER_CHAT_ID = 123456789  # ID —á–∞—Ç–∞ –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
```

### 3. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
export ENABLE_SENTRY=true
export SENTRY_DSN="https://your-dsn@sentry.io/project-id"
export PROMETHEUS_PORT=8000
export DEVELOPER_CHAT_ID=123456789
```

## üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫

### Prometheus endpoint
```
http://localhost:8000/metrics
```

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –º–µ—Ç—Ä–∏–∫–∞–º

```promql
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –≤ –º–∏–Ω—É—Ç—É
rate(telegram_bot_errors_total[1m])

# –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –∫–æ–º–∞–Ω–¥
rate(telegram_bot_command_duration_seconds_sum[5m]) / rate(telegram_bot_command_duration_seconds_count[5m])

# –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
telegram_bot_active_users

# –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞
telegram_bot_status
```

## üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ –∞–ª–µ—Ä—Ç–∞

```python
from .alerts import AlertManager

# –í Application –∏–ª–∏ –≥–¥–µ-—Ç–æ –µ—â–µ
alert_manager = AlertManager(config, metrics)

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ
alert_manager.add_alert_rule('custom_rule', {
    'enabled': True,
    'threshold': 100,
    'cooldown': 600,  # 10 –º–∏–Ω—É—Ç
    'last_alert': None
})
```

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞

```python
alert_manager.disable_alert_rule('high_error_rate')
```

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∫–æ–¥

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤

```python
from core.monitoring import measure_time, error_handler

class MyHandler(BaseHandler):
    @measure_time(metrics, 'weather_api')
    async def call_external_api(self):
        # –ö–æ–¥ API –≤—ã–∑–æ–≤–∞
        pass

    @error_handler(metrics, 'my_handler')
    async def risky_operation(self):
        # –†–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥
        pass
```

### –†—É—á–Ω–∞—è –∑–∞–ø–∏—Å—å –º–µ—Ç—Ä–∏–∫

```python
# –ó–∞–ø–∏—Å—å –æ—à–∏–±–∫–∏
metrics.record_error('DatabaseError', 'user_handler', exception)

# –ó–∞–ø–∏—Å—å –∫–æ–º–∞–Ω–¥—ã
metrics.record_command('start', 'user_handler', duration)

# –ó–∞–ø–∏—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è
metrics.record_message('text')

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
metrics.update_active_users(150)
```

## üìä Grafana –¥–∞—à–±–æ—Ä–¥—ã

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–∞–Ω–µ–ª–∏

1. **–û–±–∑–æ—Ä –æ—à–∏–±–æ–∫**
   - –ì—Ä–∞—Ñ–∏–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—à–∏–±–æ–∫ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
   - –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫
   - –¢–æ–ø –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏

2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –∫–æ–º–∞–Ω–¥
   - –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è API –≤—ã–∑–æ–≤–æ–≤
   - –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã

3. **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –¢–æ–ø –∫–æ–º–∞–Ω–¥

4. **–°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏**
   - –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏/CPU
   - –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

### –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ datasource

```json
{
  "name": "Telegram Bot Prometheus",
  "type": "prometheus",
  "url": "http://localhost:8000",
  "access": "proxy"
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```bash
pytest tests/test_monitoring.py -v
```

### –ò–º–∏—Ç–∞—Ü–∏—è –æ—à–∏–±–æ–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```python
# –í –∫–æ–¥–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
import time

async def test_error_scenario():
    # –ò–º–∏—Ç–∞—Ü–∏—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    await asyncio.sleep(6)  # > 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∞–ª–µ—Ä—Ç–∞

    # –ò–º–∏—Ç–∞—Ü–∏—è –æ—à–∏–±–∫–∏
    raise ValueError("Test error for monitoring")
```

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º—ã —Å Prometheus

1. **–ú–µ—Ç—Ä–∏–∫–∏ –Ω–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç 8000
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `prometheus_client` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

2. **–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞**
   - –£–º–µ–Ω—å—à–∏—Ç–µ —á–∞—Å—Ç–æ—Ç—É —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ sampling –¥–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö endpoint'–æ–≤

### –ü—Ä–æ–±–ª–µ–º—ã —Å Sentry

1. **–û—à–∏–±–∫–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SENTRY_DSN
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ENABLE_SENTRY=true
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

2. **–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏–π**
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤ `_before_send_sentry`
   - –£–≤–µ–ª–∏—á—å—Ç–µ `traces_sample_rate`

### –ü—Ä–æ–±–ª–µ–º—ã —Å –∞–ª–µ—Ä—Ç–∞–º–∏

1. **–ê–ª–µ—Ä—Ç—ã –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DEVELOPER_CHAT_ID
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

2. **–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∞–ª–µ—Ä—Ç–æ–≤**
   - –£–≤–µ–ª–∏—á—å—Ç–µ cooldown –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ—Ä–æ–≥–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è

## üìã TODO –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞ (CPU, –ø–∞–º—è—Ç—å, –¥–∏—Å–∫)
- [ ] –î–æ–±–∞–≤–∏—Ç—å health checks endpoint
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å retention –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è –º–µ—Ç—Ä–∏–∫ –∏ –ª–æ–≥–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤
- [ ] –°–æ–∑–¥–∞—Ç—å runbook –¥–ª—è —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –∞–ª–µ—Ä—Ç—ã

## ü§ù –í–∫–ª–∞–¥ –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ –∏–ª–∏ –∞–ª–µ—Ä—Ç–æ–≤:

1. –î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ —ç—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
2. –û–±–Ω–æ–≤–∏—Ç–µ —Ç–µ—Å—Ç—ã
3. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–∏—Å—Ç–µ–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ `bot.log`
2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Sentry
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –û–∫—Ç—è–±—Ä—å 2025*